(()=>{var e={510:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=510,e.exports=t},790:function(e,t,o){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=o(394),n=s(o(588)),i=s(o(535)),u=o(352),c=o(420);var a=t.app=(0,r.create)(__dirname);a.et.on("common_init_ready",(function(){n.default.waterfall([e=>{i.default.InitRedis(e)},e=>{(0,u.initWebsocket2)(e)}],(e=>{e&&c.log.error(e),a.listen(3e3,(()=>{c.log.info("app listen 3000")}))}))}))},216:function(e,t,o){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,r)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&s(t,e,o);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),o(888);const i=n(o(420));var u,c;i.async.waterfall([e=>{i.db.init_db(e)},e=>{o(790),e()}],(e=>{e&&i.log.error(e)})),u=process.env.PORT||"3000",c=parseInt(u,10),isNaN(c)},394:function(e,t,o){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.create=void 0;const r=s(o(252)),n=s(o(928)),i=o(176),u=s(o(898)),c=s(o(96)),a=o(19),l=o(784),d=s(o(977)),f=o(420);function m(){var e=this,t=o(465);console.log("r====",t),t.routes=t.routes||[],e.all_routes=e.all_routes||{},e.params_routes=e.params_routes||[];for(var s=0;s<t.routes.length;++s){var r=t.routes[s].module,n=o(510)(e.dir+"/routes/"+r);n.type=t.routes[s].method,n.url=t.routes[s].url,n.use_session=t.routes[s].use_session,e.all_routes[t.routes[s].url]=1;var i=t.routes[s].url.indexOf("/:");i>0&&e.params_routes.push(t.routes[s].url.substring(0,i));var u=t.routes[s].action,c=n[u];if(!c)return void f.log.error("route error:",n.type,n.url,r,u);var a=e[n.type];a&&(f.log.info("\troute:",n.type,n.url,r,u),a.call(e,n.url,c)),e.action_mods=e.action_mods||{},e.action_mods[r]=n}return process.nextTick((function(){e.et.emit("route_ready")})),e}o(465),t.create=function(e,t,o,s){var p={views:e+"/views","view engine":"pug","view options":{layout:!1},port:3e3},_=(0,r.default)();return _.et=new f.events.EventEmitter,_.on("request",(function(e,t){_.et.emit("request",e,t)})),_.dir=e,_._conf=s||{},function(e,t){for(var o in t)e.set(o,t[o]);e.default_404="<html><head><title>404 Not Found</title></head><body><center><h1>404 Not Found</h1></center><hr /><center>nginx</center></body></html>",e.process_404=function(t,o,s){o.on("evt_404",(function(){o.send(e.default_404)})),s()}}(_,p),_.init_route=m,_.use((0,c.default)("dev")),_.use(r.default.json()),_.use(r.default.urlencoded({extended:!1})),_.use((0,u.default)()),_.use((0,d.default)({secret:"thz",resave:!0,saveUninitialized:!0})),_.use(r.default.static(n.default.join(__dirname,"public"))),_.use((0,l.expressjwt)({secret:a.jwtConfig.jwtSecretKey,algorithms:["HS256"]}).unless({path:i.noAuthRoutes})),_.use(((e,t,o,s)=>{"UnauthorizedError"===e.name&&o.status(401).send("invalid token")})),_.use(_.process_404),_.init_route(),_.et.on("route_ready",(function(){_.et.emit("common_init_ready")})),_}},352:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.initWebsocket3=t.initWebsocket2=t.initWebsocket=void 0;const s=o(437),{createServer:r}=o(611),{createTokenCheck:n}=o(19),i=o(86).Server,u=(0,o(358).getLogger)("common/websocket");t.initWebsocket=e=>{const t=r(e),o=new s.Server(t,{cors:{origin:"*"}});o.use(((e,t)=>{const o=e.handshake.query.token;if(!o)return t(new Error("Token missing"));n.checkToken(o,((o,s)=>{if(o)return t(new Error("Token invalid"));e.user=s,t()}))})),o.on("connection",(e=>{u.info("a user connected"),e.on("message",(t=>{u.info(`Received message from ${e.user.username}: ${t}`),e.send(`Server received:${t}`)})),e.on("disconnect",(e=>{u.info("a user disconnected")}))}))},t.initWebsocket2=e=>{const t=r(),o=new s.Server(t,{cors:{origin:"*",credentials:!0}});global.ms.websocketIO=o,o.on("connection",(e=>{u.info("New User is Connected"),e.on("disconnect",(e=>{u.info("a user disconnected")}))})),o.of("/chat").use(((e,t)=>{let o=e.handshake.query.token.split("Bearer ")[1];if(!o)return t(new Error("not authorized"));n.checkToken(o,((o,s)=>{if(o)return(o=new Error("not authorized")).data="Token invalid",t(o);u.info(s),e.user=s,t()}))}));const i={};o.of("/chat").on("connection",(e=>{u.info("a user connected"),e.on("join",(({name:t,room:o})=>{u.info("emit join",{name:t,room:o}),e.join(o),i[o]?i[o].push({name:t,room:o,id:e.id}):i[o]=[{name:t,room:o,id:e.id}],e.emit("join",{text:"您进入了房间"}),e.emit("groupList",i),e.broadcast.to(o).emit("join",{text:`${t}进入了房间`}),e.broadcast.emit("groupList",i)})),e.on("message",(({text:t,room:o,user:s})=>{u.info("Received message",t,o,s),e.broadcast.to(o).emit("message",{text:t,user:s,self:!1}),e.emit("message",{text:t,user:s,self:!0})})),e.on("disconnect",(()=>{Object.keys(i).forEach((t=>{let o=i[t].find((t=>t.id===e.id));o&&e.broadcast.to(o.room).emit("message",{user:"管理员",text:`${o.name}离开了房间`}),i[t]=i[t].filter((t=>t.id!==e.id))})),e.broadcast.emit("groupList",i)}))})),t.listen(3001,(()=>{u.info("websocketServer is running on port 3001"),e(null)}))},t.initWebsocket3=e=>{e=r(e),new i({port:3001}).on("connection",((e,t)=>{const o=t.url.split("?token=")[1];o?n.checkToken(o,((t,o)=>{t?e.close(1008,"Token invalid"):(e.user=o,e.on("message",(t=>{u.info(`Received message from ${e.user.username}: ${t}`),e.send(`Server received: ${t}`)})),e.on("close",(()=>{u.info(`Connection closed by ${e.user.username}`)})))})):e.close(1008,"Token missing")})),u.info("WebSocket server is listening on port 3001")}},176:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.noAuthRoutes=void 0,t.noAuthRoutes=[/^\/system\/login/,/^\/system\/getCaptcha/,/^\/websocket/,/^\/socket.io/]},496:function(e,t,o){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createPoolList=t.init_db=void 0;const r=o(12),n=s(o(588)),i={host:"127.0.0.1",user:"root",password:"123456",database:"nest_admin",port:3306,waitForConnections:!0,connectionLimit:10,maxIdle:10,idleTimeout:1e4,connectTimeout:1e4,enableKeepAlive:!0,keepAliveInitialDelay:0,multipleStatements:!0},u=["nest_admin"];t.init_db=e=>{r.createConnection({host:"127.0.0.1",user:"root",password:"123456",database:"nest_admin",port:3306,connectTimeout:1e4,multipleStatements:!0}).connect((t=>{if(t)return console.log(t),e(t);console.log("mysql connect success"),e()}))},t.createPoolList=(e,t=u,o)=>{let s={};n.default.eachSeries(t,((t,o)=>{((e={})=>r.createPool({...i,...e}))({...e,database:t}).getConnection(((e,r)=>{try{if(e)return o(e);s[t]=r,o()}catch(e){console.log(e),o(e)}}))}),(e=>{if(e)return o(e);o(null,s)}))}},19:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createTokenCheck=t.jwtConfig=void 0;const s=o(829);t.jwtConfig={jwtSecretKey:"jwtSecretKey",jwtExpires:86400},t.createTokenCheck={getToken:e=>s.sign({data:e},t.jwtConfig.jwtSecretKey,{expiresIn:t.jwtConfig.jwtExpires}),checkToken:(e,o)=>s.verify(e,t.jwtConfig.jwtSecretKey,o)}},428:function(e,t,o){"use strict";var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.init_db=t.mysql=t.db_server=void 0;const r=o(496),n=s(o(588)),i=(0,o(358).getLogger)("framework/db_base");t.db_server={mysql:{}},t.mysql={},t.init_db=e=>{n.default.waterfall([e=>{(0,r.createPoolList)({},void 0,e)},(e,o)=>{Object.keys(e).forEach((o=>{t.mysql[o]=e[o]})),i.info("mysql connect success"),o()}],e)},t.default={init_db:t.init_db,mysql:t.mysql}},420:function(e,t,o){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,r)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&s(t,e,o);return r(t,e),t},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.log=t.logger=t.db=t.http=t.events=t.async=t.redis=t.session=t.express=void 0;const u=i(o(252));t.express=u.default;const c=i(o(977));t.session=c.default;const a=i(o(835));t.redis=a.default;const l=i(o(588));t.async=l.default;const d=n(o(358)),f=i(o(434));t.events=f.default;const m=i(o(611));t.http=m.default;const p=i(o(428));t.db=p.default;const _=i(o(92));t.logger=_.default,d.configure({appenders:{console:{type:"console"},cheese:{type:"file",filename:"cheese.log"}},categories:{default:{appenders:["console","cheese"],level:"debug"}},pm2:!0}),t.log=d.getLogger()},535:(e,t,o)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});const s=o(659);class r{static instance=null;constructor(){}static GetInstance(){return null==r.instance&&(r.instance=new r),r.instance}redis=null;InitRedis(e){this.redis=new s({port:6379,host:"127.0.0.1",family:4,password:"123456",db:0}),this.redis?.on("error",(function(t){return console.error("Error ",t),e(t)})),this.redis?.on("ready",(function(t){console.info("redisCache connection succeed"),e()}))}}t.default=r.GetInstance()},465:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.routes=void 0,t.routes=[{method:"post",url:"/system/login",module:"modules/system",action:"login",use_session:0},{method:"post",url:"/system/getCaptcha",module:"modules/system",action:"getCaptcha",use_session:0},{method:"post",url:"/system/verifyToken",module:"modules/system",action:"verifyToken",use_session:0},{method:"get",url:"/user/key/:key",module:"modules/users",action:"getKey",use_session:0},{method:"post",url:"/user/key",module:"modules/users",action:"setKey",use_session:0},{method:"post",url:"/user/getUserInfo",module:"modules/users",action:"getUserInfo",use_session:0},{method:"get",url:"/stream/getFile",module:"modules/stream",action:"getFile",use_session:0},{method:"post",url:"/stream/getFileStream/:name",module:"modules/stream",action:"getFileStream",use_session:0},{method:"get",url:"/redis/key/:key",module:"modules/redis",action:"getKey",use_session:0},{method:"post",url:"/socket/create",module:"modules/socket",action:"create",use_session:0},{method:"post",url:"/upload/uploadFile",module:"modules/upload",action:"uploadFile",use_session:0},{method:"post",url:"/rabbitmq/send",module:"modules/rabbitmq",action:"send",use_session:0}]},888:function(e,t,o){"use strict";var s=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var r=Object.getOwnPropertyDescriptor(t,o);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,r)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&s(t,e,o);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.ms=void 0;const i=n(o(420));global.ms=i,t.ms=i},588:e=>{"use strict";e.exports=require("async")},898:e=>{"use strict";e.exports=require("cookie-parser")},252:e=>{"use strict";e.exports=require("express")},784:e=>{"use strict";e.exports=require("express-jwt")},977:e=>{"use strict";e.exports=require("express-session")},659:e=>{"use strict";e.exports=require("ioredis")},829:e=>{"use strict";e.exports=require("jsonwebtoken")},358:e=>{"use strict";e.exports=require("log4js")},92:e=>{"use strict";e.exports=require("logger")},96:e=>{"use strict";e.exports=require("morgan")},12:e=>{"use strict";e.exports=require("mysql2")},835:e=>{"use strict";e.exports=require("redis")},437:e=>{"use strict";e.exports=require("socket.io")},86:e=>{"use strict";e.exports=require("ws")},434:e=>{"use strict";e.exports=require("events")},611:e=>{"use strict";e.exports=require("http")},928:e=>{"use strict";e.exports=require("path")}},t={};function o(s){var r=t[s];if(void 0!==r)return r.exports;var n=t[s]={exports:{}};return e[s].call(n.exports,n,n.exports,o),n.exports}o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o(216)})();